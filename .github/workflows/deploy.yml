- name: Setup SSH
  run: |
    mkdir -p ~/.ssh
    echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
    chmod 600 ~/.ssh/id_ed25519
    ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

- name: Deploy to server
  run: |
    ssh -i ~/.ssh/id_ed25519 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
      set -e
      cd ~/apps/platform
      git fetch --all
      git reset --hard origin/main

      cd backend
      pnpm install --frozen-lockfile
      pnpm prisma migrate deploy
      pnpm prisma generate
      pnpm build

      sudo systemctl restart platform-api
      sudo systemctl status platform-api --no-pager
    EOF
